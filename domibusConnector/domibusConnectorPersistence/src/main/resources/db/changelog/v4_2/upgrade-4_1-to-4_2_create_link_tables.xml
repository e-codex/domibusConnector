<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <property name="id.type" value="BIGINT" dbms="postgresql" />
    <property name="id.type" value="NUMBER(10,0)" dbms="h2,mysql" />
    <property name="id.type" value="NUMBER(10)" dbms="oracle" />

    <changeSet id="add_gateway_name_to_message_table" author="SKS">
        <comment>add gateway name to support multiple gateways/gateway tenants</comment>
        <addColumn tableName="DOMIBUS_CONNECTOR_MESSAGE">
            <column name="GATEWAY_NAME" type="java.sql.Types.VARCHAR(255)">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="create_message_lane_table" author="SKS">
        <comment>Create MessageLaneTable to support different settings for different messages</comment>
        <createTable tableName="DC_MESSAGE_LANE">
            <column name="ID" type="${id.type}">
                <constraints nullable="false"></constraints>
            </column>
            <column name="NAME" type="java.sql.Types.VARCHAR(255)" >
                <constraints nullable="false"></constraints>
            </column>
            <column name="DESCRIPTION" type="java.sql.Types.CLOB" />
        </createTable>

        <addUniqueConstraint tableName="DC_MESSAGE_LANE" columnNames="NAME" constraintName="UNQ_DC_MESSAGE_LANE" />
        <addPrimaryKey tableName="DC_MESSAGE_LANE" columnNames="ID" constraintName="PK_DC_MESSAGE_LANE_ID" />
    </changeSet>
    
    <changeSet id="create_message_lane_properties_table" author="SKS">
        <comment>Properties for message lane</comment>
        <createTable tableName="DC_MESSAGE_LANE_PROPERTY">
            <column name="DC_MESSAGE_LANE_ID" type="${id.type}">
                <constraints nullable="false"></constraints>
            </column>
            <column name="PROPERTY_NAME" type="java.sql.Types.VARCHAR(255)" >
                <constraints nullable="false"></constraints>
            </column>
            <column name="PROPERTY_VALUE" type="java.sql.Types.CLOB" />
        </createTable>

        <addPrimaryKey tableName="DC_MESSAGE_LANE_PROPERTY" columnNames="DC_MESSAGE_LANE_ID,PROPERTY_NAME" constraintName="PK_DC_MESSAGE_LANE_PROPERTY" />

        <addForeignKeyConstraint baseTableName="DC_MESSAGE_LANE_PROPERTY"
                                 baseColumnNames="DC_MESSAGE_LANE_ID"
                                 constraintName="FK_msglaneproperty_msglane"
                                 referencedTableName="DC_MESSAGE_LANE"
                                 referencedColumnNames="ID" />
    </changeSet>


    <changeSet id="create_link_config_table" author="SKS">
        <comment>Create Link Configuration Table, holds informations for the link impl</comment>
        <createTable tableName="DC_LINK_CONFIGURATION">
            <column name="ID" type="${id.type}">
                <constraints nullable="false"></constraints>
            </column>
            <column name="CONFIG_NAME" type="java.sql.Types.VARCHAR(255)" >
                <constraints nullable="false"></constraints>
            </column>
            <column name="LINK_IMPL" type="java.sql.Types.VARCHAR(255)" />
        </createTable>
        <addPrimaryKey tableName="DC_LINK_CONFIGURATION" columnNames="ID" constraintName="PK_DC_LINK_CONFIGURATION" />
        <addUniqueConstraint tableName="DC_LINK_CONFIGURATION" columnNames="CONFIG_NAME" constraintName="UNQ_DC_LINK_CONFIG_NMAE" />
    </changeSet>

    <changeSet id="create_link_property_table" author="SKS">
        <comment>Create Property Table for connector links, so each implementation can store link informations within this properties</comment>
        <createTable tableName="DC_LINK_CONFIG_PROPERTY">
            <column name="DC_LINK_CONFIGURATION_ID" type="${id.type}">
                <constraints nullable="false"></constraints>
            </column>
            <column name="PROPERTY_NAME" type="java.sql.Types.VARCHAR(255)" >
                <constraints nullable="false"></constraints>
            </column>
            <column name="PROPERTY_VALUE" type="java.sql.Types.CLOB" />
        </createTable>

        <addPrimaryKey tableName="DC_LINK_CONFIG_PROPERTY" columnNames="DC_LINK_CONFIGURATION_ID,PROPERTY_NAME" constraintName="PK_DC_LINK_CONFIG_PROPERTY" />

        <addForeignKeyConstraint baseTableName="DC_LINK_CONFIG_PROPERTY"
                                 baseColumnNames="DC_LINK_CONFIGURATION_ID"
                                 constraintName="FK_linkproperty_linkconfig"
                                 referencedTableName="DC_LINK_CONFIGURATION"
                                 referencedColumnNames="ID" />
    </changeSet>



    <changeSet id="create_link_partner_table" author="SKS">
        <comment>Create LinkTable to support different link implementations on gateway and backend side</comment>
        <createTable tableName="DC_LINK_PARTNER">
            <column name="ID" type="${id.type}">
                <constraints nullable="false"></constraints>
            </column>
            <column name="NAME" type="java.sql.Types.VARCHAR(255)" >
                <constraints nullable="false"></constraints>
            </column>
            <column name="DESCRIPTION" type="java.sql.Types.CLOB" />
            <column name="ENABLED" type="java.sql.Types.BOOLEAN" />
            <column name="LINK_CONFIG_ID" type="${id.type}" />
            <column name="LINK_TYPE" type="java.sql.Types.VARCHAR(20)" />
        </createTable>

        <addUniqueConstraint tableName="DC_LINK_PARTNER" columnNames="NAME" constraintName="UNQ_LINK_INFO_NAME" />
        <addPrimaryKey tableName="DC_LINK_PARTNER" columnNames="ID" constraintName="PK_DC_LINK_PARTNER" />
        <addForeignKeyConstraint baseTableName="DC_LINK_PARTNER"
                                 baseColumnNames="LINK_CONFIG_ID"
                                 constraintName="FK_linkinfo_linkconfig"
                                 referencedTableName="DC_LINK_CONFIGURATION"
                                 referencedColumnNames="ID" />
    </changeSet>

    <changeSet id="create_link_partner_property_table" author="SKS">
        <comment>Create Property Table for link partners, so each link partner can have his own property set</comment>
        <createTable tableName="DC_LINK_PARTNER_PROPERTY">
            <column name="DC_LINK_PARTNER_ID" type="${id.type}">
                <constraints nullable="false"></constraints>
            </column>
            <column name="PROPERTY_NAME" type="java.sql.Types.VARCHAR(255)" >
                <constraints nullable="false"></constraints>
            </column>
            <column name="PROPERTY_VALUE" type="java.sql.Types.CLOB" />
        </createTable>

        <addPrimaryKey tableName="DC_LINK_PARTNER_PROPERTY" columnNames="DC_LINK_PARTNER_ID,PROPERTY_NAME" constraintName="PK_DC_LINK_PARTNER_PROPERTY" />

        <addForeignKeyConstraint baseTableName="DC_LINK_PARTNER_PROPERTY"
                                 baseColumnNames="DC_LINK_PARTNER_ID"
                                 constraintName="FK_linkproperty_linkpartner"
                                 referencedTableName="DC_LINK_PARTNER"
                                 referencedColumnNames="ID" />
    </changeSet>


    <changeSet author="SKS" id="create_admin_user_if_not_exists">
        <preConditions onFail="CONTINUE">
            <sqlCheck expectedResult="0">
                SELECT count(1) FROM DOMIBUS_CONNECTOR_USER WHERE USERNAME='admin';
            </sqlCheck>
        </preConditions>
        <comment>Create default admin user with username admin and password admin</comment>
        <insert tableName="DOMIBUS_CONNECTOR_USER">
            <column name="USERNAME" value="admin"/>
            <column name="PASSWORD" value="2bf5e637d0d82a75ca43e3be85df2c23febffc0cc221f5e010937005df478a19b5eaab59fe7e4e97f6b43ba648c169effd432e19817f386987d058c239236306"/>
            <column name="SALT" value="5b424031616564356639"/>
            <column name="ROLE" value="admin"/>
        </insert>
    </changeSet>




</databaseChangeLog>