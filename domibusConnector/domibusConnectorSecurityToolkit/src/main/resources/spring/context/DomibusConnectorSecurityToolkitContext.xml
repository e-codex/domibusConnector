<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN 2.0//EN" "http://www.springframework.org/dtd/spring-beans-2.0.dtd">

<beans>
  
  <bean id="securityContainer" class="eu.domibus.connector.security.container.DomibusSecurityContainer">
  	<property name="javaKeyStorePath" value="${connector.security.keystore.path}" />
  	<property name="javaKeyStorePassword" value="${connector.security.keystore.password}" />
  	<property name="keyAlias" value="${connector.security.key.alias}" />
  	<property name="keyPassword" value="${connector.security.key.password}" />
  	<property name="containerService" ref="containerService"/>
  	<property name="tokenIssuer" ref="tokenIssuer"/>
  </bean>
  
  <bean id="connectorProxyDao" class="eu.domibus.connector.security.proxy.DomibusConnectorProxyDao">
  	<constructor-arg value="${http.proxy.enabled}"/>
  	<constructor-arg value="${http.proxy.host}"/>
  	<constructor-arg value="${http.proxy.port}"/>
  	<constructor-arg value="${http.proxy.user}"/>
  	<constructor-arg value="${http.proxy.password}"/>
  </bean>
  
  <bean id="proxyPreferenceManager" class="eu.europa.ec.markt.dss.manager.ProxyPreferenceManager">
  	<property name="proxyDao" ref="connectorProxyDao"/>
  </bean>
  
  <bean id="httpDataLoader" class="eu.ecodex.dss.util.ECodexDataLoader" scope="prototype">
  	<property name="allowLDAP" value="${connector.security.allow.ldap:false}" />
  	<property name="proxyPreferenceManager" ref="proxyPreferenceManager"/>
  </bean>
  
  <bean id="ocspDataLoader" class="eu.ecodex.dss.util.ECodexDataLoader" scope="prototype">
  	<property name="allowLDAP" value="${connector.security.allow.ldap:false}" />
  	<property name="proxyPreferenceManager" ref="proxyPreferenceManager"/>
  	<property name="contentType" value="application/ocsp-request"/>
  </bean>
  
  <bean id="trustedListsCertificateSource" class="eu.europa.ec.markt.dss.validation102853.tsl.TrustedListsCertificateSource" init-method="init">
  	<property name="dataLoader" ref="httpDataLoader"/>
  	<property name="checkSignature" value="false"/>
  	<property name="lotlUrl" value="https://ec.europa.eu/information_society/policy/esignature/trusted-list/tl-mp.xml"/>
  </bean>
  
  <bean id="onlineCRLSource" class="eu.europa.ec.markt.dss.validation102853.crl.OnlineCRLSource">
  	<property name="dataLoader" ref="httpDataLoader"/>
  </bean>
  
  <bean id="ocspSource" class="eu.europa.ec.markt.dss.validation102853.ocsp.OnlineOCSPSource">
  	<property name="dataLoader" ref="ocspDataLoader"/>
  </bean>
  
  <bean id="certificateVerifier" class="eu.europa.ec.markt.dss.validation102853.CommonCertificateVerifier">
  	<property name="crlSource" ref="onlineCRLSource"/>
  	<property name="ocspSource" ref="ocspSource"/>
  	<property name="dataLoader" ref="httpDataLoader"/>
  	<property name="trustedCertSource" ref="trustedListsCertificateSource"/>
  </bean>
  
  <bean id="trustedCertificates" class="eu.ecodex.dss.model.CertificateStoreInfo" >
		<property name="location" value="${java.truststore.path}" />
		<property name="password" value="${java.truststore.password}" />
	</bean>

	<bean id="environmentConfiguration" class="eu.ecodex.dss.model.EnvironmentConfiguration" >
		<property name="connectorCertificates" ref="trustedCertificates" />
	</bean>
	
  <bean id="legalValidationService" class="eu.ecodex.dss.service.impl.dss.DSSECodexLegalValidationService">
  	<property name="environmentConfiguration" ref="environmentConfiguration"/>
  </bean>
  
  <bean id="technicalValidationService" class="eu.ecodex.dss.service.impl.dss.DSSECodexTechnicalValidationService">
  	<property name="certificateVerifier" ref="certificateVerifier"/>
  	<property name="proxyPreferenceManager" ref="proxyPreferenceManager"/>
  	<property name="environmentConfiguration" ref="environmentConfiguration"/>
  </bean>
  
  <bean id="containerService" class="eu.ecodex.dss.service.impl.dss.DSSECodexContainerService">
  	<property name="certificateVerifier" ref="certificateVerifier"/>
  	<property name="legalValidationService" ref="legalValidationService"/>
  	<property name="technicalValidationService" ref="technicalValidationService"/>
  	<property name="environmentConfiguration" ref="environmentConfiguration"/>
  </bean>
  
  <bean id="tokenIssuer" class="eu.ecodex.dss.model.token.TokenIssuer">
  	<property name="country" value="${token.issuer.country}" />
  	<property name="serviceProvider" value="${token.issuer.service.provider}" />
  	<property name="advancedElectronicSystem" value="${token.issuer.aes.value}" />
  </bean>
  
  <!-- <bean id="connectorSecurityToolkitFactory" class="eu.domibus.connector.security.DomibusConnectorSecurityToolkitFactory">
  	<property name="implementationClassName" value="${connector.security.toolkit.implementation.class.name}" />
  </bean> -->
  
  <bean id="connectorSecurityToolkitFactory" class="eu.domibus.connector.common.NationalImplementationFactory">
  	<property name="implementationClassName" value="${connector.security.toolkit.implementation.class.name}" />
  	<property name="implClassPropertyName" value="connector.security.toolkit.implementation.class.name" />
  	<property name="defaultImplementationClassName" value="eu.domibus.connector.security.DomibusConnectorSecurityToolkitDefaultImpl" />
  	<property name="preConditions">
		<map>
			<entry key="connector.use.security.toolkit" value="${connector.use.security.toolkit}" />
		</map>
	</property>
  </bean>

  <bean id="connectorSecurityToolkit" factory-bean="connectorSecurityToolkitFactory" factory-method="createImplementation">
  	<property name="securityContainer" ref="securityContainer" />
  </bean>
  
</beans>