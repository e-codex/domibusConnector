node {

	println("start release")

		
	stage("checkout") {
		cleanWs()
		sh 'git config --global credential.helper cache'
		sh 'git config --global push.default simple'
		def scm = checkout([$class: 'GitSCM', branches: [[name: 'development']], doGenerateSubmoduleConfigurations: false, extensions: [], gitTool: 'Default', submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'IT-NRW GIT Repo', url: 'https://secure.e-codex.eu/gitblit/r/e-CODEX/WP5/connector.git']]])		
	}
	
	stage("determine version number") {
		gitDescribe = sh(returnStdout: true, script: 'git describe').trim();
		println("GIT DESCRIBE IS ${gitDescribe}")
		
		//remove -23-gbdsaed postfix from git describe output, to extract the tag name of the first parent (see git describe documentation)
		def verssplit = gitDescribe.split("-")[-2..-1];
		println("verssplit is ${verssplit}")
		def vers = gitDescribe.replace("-" + verssplit[0] + "-" + verssplit[1], "")
		println("vers is ${vers}") //tag name is in vers
		
		if (vers[0] == 'v') {
			vers = vers.substring(1, vers.length)
		}
		(major, minor, patch) = vers.tokenize(".") //split tag name into versions...
		
		def postfix = ""
		// if - in patch increment last number in patch else increment minor number
		if (patch.contains("-")) {
			def m = patch =~ /(\d+)-([A-Za-z]+)(\d+)?/
			println("m: ${m}")
			def p = m.group(0)
			println("p: ${p}")
			def t = m.group(1)
			println("t: ${t}")
			def n = m.group(2)
			println("n: ${n}")			
			//def patchnumber = m[0][0]
			//def match1 = m[1][0]
			def postfixnumber = 0
			if (m.length() > 2) {
				//contains number
				postfixnumber = (m[2][0] as Integer) + 1
			}
			postfix = match1 + postfixnumber
			patch = patchnumber + "-" + match1 + postfixnumber
			m = null //
		} else {	
			minor = (minor as Integer) + 1
		}
		 
		
		releaseVersion = "${major}.${minor}.${patch}"
			
		
		def userInput = input(
			id: 'userInput', message: 'Let\'s release?', parameters: [
			[$class: 'TextParameterDefinition', defaultValue: releaseVersion, description: 'New Release Version Suggestion', name: 'rel']
		])
		
		println("user input is ${userInput}")
		
		releaseVersion = userInput
	
	}
	
	stage("create branch") {
	
		sh "git checkout -b release/v${releaseVersion}"
		
		sh "git push -f origin release/v${releaseVersion}"
	}
	
	
	
}